import 'intl-pluralrules';
import i18n from 'i18next';
import { initReactI18next } from 'react-i18next';
import * as Localization from 'expo-localization';
import AsyncStorage from '@react-native-async-storage/async-storage';

const resources = {
  es: {
    translation: {
      common: {
        loading: 'Cargando...',
        error: 'Error',
        success: 'Éxito',
        cancel: 'Cancelar',
        save: 'Guardar',
        delete: 'Eliminar',
        edit: 'Editar',
        close: 'Cerrar',
        confirm: 'Confirmar',
        search: 'Buscar',
        all: 'Todos',
        new: 'NUEVO',
        yesterday: 'Ayer',
        version: 'Versión',
        build: 'Build',
        understood: 'Entendido',
        ok: 'OK',
      },
      auth: {
        login: 'Iniciar Sesión',
        logout: 'Cerrar Sesión',
        register: 'Registrarse',
        forgotPassword: '¿Olvidaste tu contraseña?',
        email: 'Correo electrónico',
        password: 'Contraseña',
        confirmPassword: 'Confirmar contraseña',
        name: 'Nombre',
        phone: 'Teléfono',
        appTitle: 'ColeApp',
        appSubtitle: 'Conectando colegios y familias',
        loginButton: 'Iniciar Sesión',
        noAccount: '¿No tienes cuenta?',
        registerButton: 'Regístrate',
        emailRequired: 'El email es requerido',
        emailInvalid: 'Email inválido',
        passwordRequired: 'La contraseña es requerida',
        passwordTooShort: 'La contraseña debe tener al menos 6 caracteres',
        loginError: 'No se pudo iniciar sesión. Intenta nuevamente.',
        logoutConfirm: '¿Estás seguro que deseas cerrar sesión?',
      },
      tabs: {
        news: 'Novedades',
        events: 'Eventos',
        messages: 'Mensajes',
        exitPermissions: 'Salidas',
        reports: 'Boletines',
      },
      news: {
        title: 'Novedades',
        empty: 'No hay novedades',
        urgent: 'URGENTE',
        categories: {
          all: 'Todos',
          academic: 'Académico',
          events: 'Eventos',
          urgent: 'Urgente',
          sports: 'Deportes',
        },
        filterBy: 'Filtrar por',
      },
      events: {
        title: 'Eventos',
        empty: 'No hay eventos próximos',
        emptyDate: 'No hay eventos el {{date}}',
        rsvp: 'Confirmar asistencia',
        attending: 'Asistirás',
        notAttending: 'No asistirás',
        maybe: 'Tal vez',
        registered: 'Inscrito',
        attendees: '{{current}}/{{max}} asistentes confirmados',
        eventsOn: 'Eventos del {{date}}',
        viewAll: 'Ver todos',
        filterBy: 'Filtrar por',
        description: 'Descripción',
        requirements: 'Requisitos',
        attendance: 'Asistencia',
        filters: {
          all: 'Todos',
          unread: 'No leídos',
        },
        categories: {
          festival: 'Festival',
          meeting: 'Reunión',
          sports: 'Deportes',
          cultural: 'Cultural',
        },
      },
      messages: {
        title: 'Mensajes',
        empty: 'No hay mensajes',
        send: 'Enviar',
        typeMessage: 'Escribe un mensaje...',
        loadingMessages: 'Cargando mensajes…',
        createMessage: 'Crear nuevo mensaje',
        unread: 'No leídos',
        filterBy: 'Filtrar por',
        cannotReplyTitle: 'No se puede responder',
        cannotReplyMessage: 'Este mensaje no permite respuestas. Si necesita comunicarse, puede iniciar una nueva conversación.',
        options: 'Opciones',
        reply: 'Responder',
        copyText: 'Copiar texto',
        copied: 'Copiado',
        copiedMessage: 'Mensaje copiado al portapapeles',
        urgent: 'URGENTE',
        lowPriority: 'BAJA PRIORIDAD',
        noReplies: 'Sin respuestas',
        replyingTo: 'Respondiendo a',
        messageType: 'Tipo',
        inquiry: 'Consulta',
        response: 'Respuesta',
        conversationLocked: 'Esta conversación no permite respuestas',
        conversationOptions: 'Opciones de Conversación',
        viewContactInfo: 'Ver información del contacto',
        muteNotifications: 'Silenciar notificaciones',
        archiveConversation: 'Archivar conversación',
        deleteConversation: 'Eliminar conversación',
        recipient: 'Destinatario',
        selectRecipient: 'Seleccionar destinatario',
        relatedStudent: 'Estudiante Relacionado',
        quickTemplates: 'Plantillas Rápidas (Opcional)',
        subject: 'Asunto',
        enterSubject: 'Ingrese el asunto del mensaje',
        message: 'Mensaje',
        writeMessageHere: 'Escriba su mensaje aquí...',
        messageOptions: 'Opciones del Mensaje',
        priority: 'Prioridad',
        normalPriority: 'Normal',
        highPriority: 'Alta',
        allowReplies: 'Permitir Respuestas',
        allowRepliesDescription: 'Si está desactivado, el destinatario no podrá responder a este mensaje',
        notification: 'Notificación',
        communicationGuidelines: 'Pautas de Comunicación',
        guidelinesBeClearConcise: '• Sea claro y conciso en su mensaje',
        guidelinesUseRespectfulTone: '• Use un tono respetuoso y formal',
        guidelinesIncludeRelevantInfo: '• Incluya toda la información relevante',
        guidelinesUrgentFirst: '• Los mensajes urgentes serán atendidos primero',
        validation: {
          selectRecipient: 'Por favor seleccione un destinatario',
          enterSubject: 'Por favor ingrese un asunto',
          writeMessage: 'Por favor escriba un mensaje',
          messageMinLength: 'El mensaje debe tener al menos 10 caracteres',
        },
        confirmSend: 'Confirmar Envío',
        confirmSendMessage: '¿Desea enviar este mensaje a {{recipient}}?',
        messageSent: 'Mensaje Enviado',
        messageSentDescription: 'Su mensaje ha sido enviado exitosamente. Recibirá una notificación cuando obtenga una respuesta.',
      },
      permissions: {
        title: 'Cambios de Salida',
        create: 'Solicitar Cambio',
        empty: 'No hay permisos solicitados',
        exitDate: 'Salida',
        dni: 'DNI',
        comments: 'Comentarios',
        requestedDate: 'Solicitado',
        status: {
          pending: 'Pendiente',
          approved: 'Aprobado',
          rejected: 'Rechazado',
          cancelled: 'Cancelado',
        },
      },
      reports: {
        title: 'Boletines e Informes',
        empty: 'No hay reportes disponibles',
        download: 'Descargar',
        view: 'Ver',
        pending: 'En proceso',
        refresh: 'Actualizar',
      },
      profile: {
        title: 'Perfil',
        personalInfo: 'Información Personal',
        children: 'Hijos',
        settings: 'Configuración',
        support: 'Soporte',
        email: 'Email',
        phone: 'Teléfono',
        dni: 'DNI',
        notifications: 'Notificaciones Push',
        emailNotifications: 'Notificaciones por Email',
        changePassword: 'Cambiar Contraseña',
        language: 'Idioma',
        languageName: 'Español',
        helpCenter: 'Centro de Ayuda',
        contactSupport: 'Contactar Soporte',
        termsConditions: 'Términos y Condiciones',
        privacyPolicy: 'Política de Privacidad',
        motherRole: 'Madre de Familia',
        grade: 'Grado',
        selectLanguage: 'Seleccionar Idioma',
        languageChanged: 'Idioma cambiado exitosamente',
      },
      languages: {
        es: 'Español',
        en: 'English',
        pt: 'Português',
        fr: 'Français',
        it: 'Italiano',
      },
    },
  },
  en: {
    translation: {
      common: {
        loading: 'Loading...',
        error: 'Error',
        success: 'Success',
        cancel: 'Cancel',
        save: 'Save',
        delete: 'Delete',
        edit: 'Edit',
        close: 'Close',
        confirm: 'Confirm',
        search: 'Search',
        all: 'All',
        new: 'NEW',
        yesterday: 'Yesterday',
        version: 'Version',
        build: 'Build',
        understood: 'Understood',
        ok: 'OK',
      },
      auth: {
        login: 'Sign In',
        logout: 'Sign Out',
        register: 'Sign Up',
        forgotPassword: 'Forgot Password?',
        email: 'Email',
        password: 'Password',
        confirmPassword: 'Confirm Password',
        name: 'Name',
        phone: 'Phone',
        appTitle: 'ColeApp',
        appSubtitle: 'Connecting schools and families',
        loginButton: 'Sign In',
        noAccount: "Don't have an account?",
        registerButton: 'Sign Up',
        emailRequired: 'Email is required',
        emailInvalid: 'Invalid email',
        passwordRequired: 'Password is required',
        passwordTooShort: 'Password must be at least 6 characters',
        loginError: 'Could not sign in. Please try again.',
        logoutConfirm: 'Are you sure you want to sign out?',
      },
      tabs: {
        news: 'News',
        events: 'Events',
        messages: 'Messages',
        exitPermissions: 'Exit Permits',
        reports: 'Reports',
      },
      news: {
        title: 'News',
        empty: 'No news available',
        urgent: 'URGENT',
        categories: {
          all: 'All',
          academic: 'Academic',
          events: 'Events',
          urgent: 'Urgent',
          sports: 'Sports',
        },
        filterBy: 'Filter by',
      },
      events: {
        title: 'Events',
        empty: 'No upcoming events',
        emptyDate: 'No events on {{date}}',
        rsvp: 'RSVP',
        attending: 'Attending',
        notAttending: 'Not Attending',
        maybe: 'Maybe',
        registered: 'Registered',
        attendees: '{{current}}/{{max}} attendees confirmed',
        eventsOn: 'Events on {{date}}',
        viewAll: 'View all',
        filterBy: 'Filter by',
        description: 'Description',
        requirements: 'Requirements',
        attendance: 'Attendance',
        filters: {
          all: 'All',
          unread: 'Unread',
        },
        categories: {
          festival: 'Festival',
          meeting: 'Meeting',
          sports: 'Sports',
          cultural: 'Cultural',
        },
      },
      messages: {
        title: 'Messages',
        empty: 'No messages',
        send: 'Send',
        typeMessage: 'Type a message...',
        loadingMessages: 'Loading messages…',
        createMessage: 'Create new message',
        unread: 'Unread',
        filterBy: 'Filter by',
      },
      permissions: {
        title: 'Exit Permissions',
        create: 'Request Permission',
        empty: 'No permissions requested',
        status: {
          pending: 'Pending',
          approved: 'Approved',
          rejected: 'Rejected',
          cancelled: 'Cancelled',
        },
      },
      reports: {
        title: 'Reports & Bulletins',
        empty: 'No reports available',
        download: 'Download',
        view: 'View',
      },
      profile: {
        title: 'Profile',
        personalInfo: 'Personal Information',
        children: 'Children',
        settings: 'Settings',
        support: 'Support',
        email: 'Email',
        phone: 'Phone',
        dni: 'ID',
        notifications: 'Push Notifications',
        emailNotifications: 'Email Notifications',
        changePassword: 'Change Password',
        language: 'Language',
        languageName: 'English',
        helpCenter: 'Help Center',
        contactSupport: 'Contact Support',
        termsConditions: 'Terms and Conditions',
        privacyPolicy: 'Privacy Policy',
        motherRole: 'Mother',
        grade: 'Grade',
        selectLanguage: 'Select Language',
        languageChanged: 'Language changed successfully',
      },
      languages: {
        es: 'Español',
        en: 'English',
        pt: 'Português',
        fr: 'Français',
        it: 'Italiano',
      },
    },
  },
  pt: {
    translation: {
      common: {
        loading: 'Carregando...',
        error: 'Erro',
        success: 'Sucesso',
        cancel: 'Cancelar',
        save: 'Salvar',
        delete: 'Excluir',
        edit: 'Editar',
        close: 'Fechar',
        confirm: 'Confirmar',
        search: 'Buscar',
        all: 'Todos',
        new: 'NOVO',
        yesterday: 'Ontem',
        version: 'Versão',
        build: 'Build',
      },
      auth: {
        login: 'Entrar',
        logout: 'Sair',
        register: 'Registrar',
        forgotPassword: 'Esqueceu a senha?',
        email: 'E-mail',
        password: 'Senha',
        confirmPassword: 'Confirmar senha',
        name: 'Nome',
        phone: 'Telefone',
        appTitle: 'ColeApp',
        appSubtitle: 'Conectando escolas e famílias',
        loginButton: 'Entrar',
        noAccount: 'Não tem uma conta?',
        registerButton: 'Registrar',
        emailRequired: 'E-mail é obrigatório',
        emailInvalid: 'E-mail inválido',
        passwordRequired: 'Senha é obrigatória',
        passwordTooShort: 'Senha deve ter pelo menos 6 caracteres',
        loginError: 'Não foi possível entrar. Tente novamente.',
        logoutConfirm: 'Tem certeza que deseja sair?',
      },
      tabs: {
        news: 'Notícias',
        events: 'Eventos',
        messages: 'Mensagens',
        exitPermissions: 'Saídas',
        reports: 'Boletins',
      },
      news: {
        title: 'Notícias',
        empty: 'Nenhuma notícia disponível',
        urgent: 'URGENTE',
        categories: {
          all: 'Todos',
          academic: 'Acadêmico',
          events: 'Eventos',
          urgent: 'Urgente',
          sports: 'Esportes',
        },
        filterBy: 'Filtrar por',
      },
      events: {
        title: 'Eventos',
        empty: 'Nenhum evento próximo',
        emptyDate: 'Nenhum evento em {{date}}',
        rsvp: 'Confirmar presença',
        attending: 'Participarei',
        notAttending: 'Não participarei',
        maybe: 'Talvez',
        registered: 'Inscrito',
        attendees: '{{current}}/{{max}} participantes confirmados',
        eventsOn: 'Eventos em {{date}}',
        viewAll: 'Ver todos',
        filterBy: 'Filtrar por',
        filters: {
          all: 'Todos',
          unread: 'Não lidos',
        },
        categories: {
          festival: 'Festival',
          meeting: 'Reunião',
          sports: 'Esportes',
          cultural: 'Cultural',
        },
      },
      messages: {
        title: 'Mensagens',
        empty: 'Nenhuma mensagem',
        send: 'Enviar',
        typeMessage: 'Digite uma mensagem...',
        loadingMessages: 'Carregando mensagens…',
        createMessage: 'Criar nova mensagem',
        unread: 'Não lidas',
        filterBy: 'Filtrar por',
      },
      permissions: {
        title: 'Permissões de Saída',
        create: 'Solicitar Permissão',
        empty: 'Nenhuma permissão solicitada',
        status: {
          pending: 'Pendente',
          approved: 'Aprovado',
          rejected: 'Rejeitado',
          cancelled: 'Cancelado',
        },
      },
      reports: {
        title: 'Relatórios e Boletins',
        empty: 'Nenhum relatório disponível',
        download: 'Baixar',
        view: 'Ver',
      },
      profile: {
        title: 'Perfil',
        personalInfo: 'Informações Pessoais',
        children: 'Filhos',
        settings: 'Configurações',
        support: 'Suporte',
        email: 'E-mail',
        phone: 'Telefone',
        dni: 'CPF',
        notifications: 'Notificações Push',
        emailNotifications: 'Notificações por E-mail',
        changePassword: 'Alterar Senha',
        language: 'Idioma',
        languageName: 'Português',
        helpCenter: 'Central de Ajuda',
        contactSupport: 'Contatar Suporte',
        termsConditions: 'Termos e Condições',
        privacyPolicy: 'Política de Privacidade',
        motherRole: 'Mãe de Família',
        grade: 'Série',
        selectLanguage: 'Selecionar Idioma',
        languageChanged: 'Idioma alterado com sucesso',
      },
      languages: {
        es: 'Español',
        en: 'English',
        pt: 'Português',
        fr: 'Français',
        it: 'Italiano',
      },
    },
  },
  fr: {
    translation: {
      common: {
        loading: 'Chargement...',
        error: 'Erreur',
        success: 'Succès',
        cancel: 'Annuler',
        save: 'Enregistrer',
        delete: 'Supprimer',
        edit: 'Modifier',
        close: 'Fermer',
        confirm: 'Confirmer',
        search: 'Rechercher',
        all: 'Tous',
        new: 'NOUVEAU',
        yesterday: 'Hier',
        version: 'Version',
        build: 'Build',
      },
      auth: {
        login: 'Se connecter',
        logout: 'Se déconnecter',
        register: "S'inscrire",
        forgotPassword: 'Mot de passe oublié?',
        email: 'E-mail',
        password: 'Mot de passe',
        confirmPassword: 'Confirmer le mot de passe',
        name: 'Nom',
        phone: 'Téléphone',
        appTitle: 'ColeApp',
        appSubtitle: 'Connecter les écoles et les familles',
        loginButton: 'Se connecter',
        noAccount: "Vous n'avez pas de compte?",
        registerButton: "S'inscrire",
        emailRequired: 'E-mail requis',
        emailInvalid: 'E-mail invalide',
        passwordRequired: 'Mot de passe requis',
        passwordTooShort: 'Le mot de passe doit contenir au moins 6 caractères',
        loginError: 'Impossible de se connecter. Veuillez réessayer.',
        logoutConfirm: 'Êtes-vous sûr de vouloir vous déconnecter?',
      },
      tabs: {
        news: 'Actualités',
        events: 'Événements',
        messages: 'Messages',
        exitPermissions: 'Sorties',
        reports: 'Bulletins',
      },
      news: {
        title: 'Actualités',
        empty: 'Aucune actualité disponible',
        urgent: 'URGENT',
        categories: {
          all: 'Tous',
          academic: 'Académique',
          events: 'Événements',
          urgent: 'Urgent',
          sports: 'Sports',
        },
        filterBy: 'Filtrer par',
      },
      events: {
        title: 'Événements',
        empty: 'Aucun événement à venir',
        emptyDate: 'Aucun événement le {{date}}',
        rsvp: 'Confirmer la présence',
        attending: 'Je participe',
        notAttending: 'Je ne participe pas',
        maybe: 'Peut-être',
        registered: 'Inscrit',
        attendees: '{{current}}/{{max}} participants confirmés',
        eventsOn: 'Événements du {{date}}',
        viewAll: 'Voir tout',
        filterBy: 'Filtrer par',
        filters: {
          all: 'Tous',
          unread: 'Non lus',
        },
        categories: {
          festival: 'Festival',
          meeting: 'Réunion',
          sports: 'Sports',
          cultural: 'Culturel',
        },
      },
      messages: {
        title: 'Messages',
        empty: 'Aucun message',
        send: 'Envoyer',
        typeMessage: 'Tapez un message...',
        loadingMessages: 'Chargement des messages…',
        createMessage: 'Créer un nouveau message',
        unread: 'Non lus',
        filterBy: 'Filtrer par',
      },
      permissions: {
        title: 'Permissions de Sortie',
        create: 'Demander une Permission',
        empty: 'Aucune permission demandée',
        status: {
          pending: 'En attente',
          approved: 'Approuvé',
          rejected: 'Rejeté',
          cancelled: 'Annulé',
        },
      },
      reports: {
        title: 'Rapports et Bulletins',
        empty: 'Aucun rapport disponible',
        download: 'Télécharger',
        view: 'Voir',
      },
      profile: {
        title: 'Profil',
        personalInfo: 'Informations Personnelles',
        children: 'Enfants',
        settings: 'Paramètres',
        support: 'Support',
        email: 'E-mail',
        phone: 'Téléphone',
        dni: 'ID',
        notifications: 'Notifications Push',
        emailNotifications: 'Notifications par E-mail',
        changePassword: 'Changer le Mot de Passe',
        language: 'Langue',
        languageName: 'Français',
        helpCenter: "Centre d'Aide",
        contactSupport: 'Contacter le Support',
        termsConditions: 'Termes et Conditions',
        privacyPolicy: 'Politique de Confidentialité',
        motherRole: 'Mère de Famille',
        grade: 'Niveau',
        selectLanguage: 'Sélectionner la Langue',
        languageChanged: 'Langue modifiée avec succès',
      },
      languages: {
        es: 'Español',
        en: 'English',
        pt: 'Português',
        fr: 'Français',
        it: 'Italiano',
      },
    },
  },
  it: {
    translation: {
      common: {
        loading: 'Caricamento...',
        error: 'Errore',
        success: 'Successo',
        cancel: 'Annulla',
        save: 'Salva',
        delete: 'Elimina',
        edit: 'Modifica',
        close: 'Chiudi',
        confirm: 'Conferma',
        search: 'Cerca',
        all: 'Tutti',
        new: 'NUOVO',
        yesterday: 'Ieri',
        version: 'Versione',
        build: 'Build',
      },
      auth: {
        login: 'Accedi',
        logout: 'Esci',
        register: 'Registrati',
        forgotPassword: 'Password dimenticata?',
        email: 'E-mail',
        password: 'Password',
        confirmPassword: 'Conferma password',
        name: 'Nome',
        phone: 'Telefono',
        appTitle: 'ColeApp',
        appSubtitle: 'Connettere scuole e famiglie',
        loginButton: 'Accedi',
        noAccount: 'Non hai un account?',
        registerButton: 'Registrati',
        emailRequired: 'E-mail richiesta',
        emailInvalid: 'E-mail non valida',
        passwordRequired: 'Password richiesta',
        passwordTooShort: 'La password deve contenere almeno 6 caratteri',
        loginError: 'Impossibile accedere. Riprova.',
        logoutConfirm: 'Sei sicuro di voler uscire?',
      },
      tabs: {
        news: 'Notizie',
        events: 'Eventi',
        messages: 'Messaggi',
        exitPermissions: 'Uscite',
        reports: 'Bollettini',
      },
      news: {
        title: 'Notizie',
        empty: 'Nessuna notizia disponibile',
        urgent: 'URGENTE',
        categories: {
          all: 'Tutti',
          academic: 'Accademico',
          events: 'Eventi',
          urgent: 'Urgente',
          sports: 'Sport',
        },
        filterBy: 'Filtra per',
      },
      events: {
        title: 'Eventi',
        empty: 'Nessun evento in programma',
        emptyDate: 'Nessun evento il {{date}}',
        rsvp: 'Conferma presenza',
        attending: 'Parteciperò',
        notAttending: 'Non parteciperò',
        maybe: 'Forse',
        registered: 'Iscritto',
        attendees: '{{current}}/{{max}} partecipanti confermati',
        eventsOn: 'Eventi del {{date}}',
        viewAll: 'Vedi tutti',
        filterBy: 'Filtra per',
        filters: {
          all: 'Tutti',
          unread: 'Non letti',
        },
        categories: {
          festival: 'Festival',
          meeting: 'Riunione',
          sports: 'Sport',
          cultural: 'Culturale',
        },
      },
      messages: {
        title: 'Messaggi',
        empty: 'Nessun messaggio',
        send: 'Invia',
        typeMessage: 'Scrivi un messaggio...',
        loadingMessages: 'Caricamento messaggi…',
        createMessage: 'Crea nuovo messaggio',
        unread: 'Non letti',
        filterBy: 'Filtra per',
      },
      permissions: {
        title: 'Permessi di Uscita',
        create: 'Richiedi Permesso',
        empty: 'Nessun permesso richiesto',
        status: {
          pending: 'In attesa',
          approved: 'Approvato',
          rejected: 'Rifiutato',
          cancelled: 'Annullato',
        },
      },
      reports: {
        title: 'Rapporti e Bollettini',
        empty: 'Nessun rapporto disponibile',
        download: 'Scarica',
        view: 'Visualizza',
      },
      profile: {
        title: 'Profilo',
        personalInfo: 'Informazioni Personali',
        children: 'Figli',
        settings: 'Impostazioni',
        support: 'Supporto',
        email: 'E-mail',
        phone: 'Telefono',
        dni: 'ID',
        notifications: 'Notifiche Push',
        emailNotifications: 'Notifiche via E-mail',
        changePassword: 'Cambia Password',
        language: 'Lingua',
        languageName: 'Italiano',
        helpCenter: 'Centro Assistenza',
        contactSupport: 'Contatta Supporto',
        termsConditions: 'Termini e Condizioni',
        privacyPolicy: 'Privacy Policy',
        motherRole: 'Madre di Famiglia',
        grade: 'Classe',
        selectLanguage: 'Seleziona Lingua',
        languageChanged: 'Lingua cambiata con successo',
      },
      languages: {
        es: 'Español',
        en: 'English',
        pt: 'Português',
        fr: 'Français',
        it: 'Italiano',
      },
    },
  },
};

const LANGUAGE_STORAGE_KEY = '@ColeApp:language';

const languageDetector = {
  type: 'languageDetector' as const,
  async: true,
  detect: async (callback: (lang: string) => void) => {
    try {
      // First check if user has manually selected a language
      const savedLanguage = await AsyncStorage.getItem(LANGUAGE_STORAGE_KEY);
      if (savedLanguage && resources[savedLanguage as keyof typeof resources]) {
        callback(savedLanguage);
        return;
      }

      // Fall back to device language
      const locale = Localization.getLocales?.()?.[0];
      let lang = locale?.languageCode || 'es';

      // Make sure the detected language is supported, fallback to Spanish
      if (!resources[lang as keyof typeof resources]) {
        lang = 'es';
      }

      callback(lang);
    } catch (e) {
      callback('es');
    }
  },
  init: () => {},
  cacheUserLanguage: async (language: string) => {
    try {
      await AsyncStorage.setItem(LANGUAGE_STORAGE_KEY, language);
    } catch (e) {
      console.warn('Failed to save language preference:', e);
    }
  },
};

i18n
  .use(languageDetector)
  .use(initReactI18next)
  .init({
    resources,
    fallbackLng: 'es',
    interpolation: {
      escapeValue: false,
    },
    react: {
      useSuspense: false,
    },
    compatibilityJSON: 'v3', // Soluciona el warning de pluralResolver
  });

// Helper function to change language
export const changeLanguage = async (language: string) => {
  try {
    await i18n.changeLanguage(language);
    await AsyncStorage.setItem(LANGUAGE_STORAGE_KEY, language);
    return true;
  } catch (error) {
    console.warn('Failed to change language:', error);
    return false;
  }
};

// Available languages
export const availableLanguages = Object.keys(resources);

export default i18n;
